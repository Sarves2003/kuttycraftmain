const GOOGLE_SHEET_URL="https://script.google.com/macros/s/AKfycbw-e-ye_2aA-JYk82CDPDJQqRKxoc7_STfpxob60IDqD5aPSLdIGQ8STvlasVjPkQ-6/exec",SECRET_TOKEN="KC_xsdf32qR7wL4nV8kT3bY6hF5gD1sA",allProducts=productsData;let currentFilter="all",displayedProducts=[],currentPage=0;const productsPerPage=10;let cart=[],selectedProduct=null,currentQuantity=1,paymentDetails=null,currentImageIndex=0;const elements={header:document.getElementById("header"),cartIcon:document.getElementById("cartIcon"),cartBadge:document.getElementById("cartBadge"),filterButtons:document.querySelectorAll(".filter-btn"),productsGrid:document.getElementById("productsGrid"),loadMoreContainer:document.getElementById("loadMoreContainer"),loadMoreBtn:document.getElementById("loadMoreBtn"),allLoadedMessage:document.getElementById("allLoadedMessage"),productModal:document.getElementById("productModal"),modalOverlay:document.getElementById("modalOverlay"),modalClose:document.getElementById("modalClose"),modalTitle:document.getElementById("modalTitle"),modalDescription:document.getElementById("modalDescription"),modalPrice:document.getElementById("modalPrice"),qtyValue:document.getElementById("qtyValue"),decreaseQty:document.getElementById("decreaseQty"),increaseQty:document.getElementById("increaseQty"),addToCartBtn:document.getElementById("addToCartBtn"),cartSidebar:document.getElementById("cartSidebar"),cartClose:document.getElementById("cartClose"),cartItems:document.getElementById("cartItems"),cartEmpty:document.getElementById("cartEmpty"),cartFooter:document.getElementById("cartFooter"),totalAmount:document.getElementById("totalAmount"),payNowBtn:document.getElementById("payNowBtn"),checkoutModal:document.getElementById("checkoutModal"),checkoutOverlay:document.getElementById("checkoutOverlay"),checkoutClose:document.getElementById("checkoutClose"),checkoutForm:document.getElementById("checkoutForm"),summaryItems:document.getElementById("summaryItems"),summaryAmount:document.getElementById("summaryAmount"),successPage:document.getElementById("successPage"),backHomeBtn:document.getElementById("backHomeBtn"),carouselContainer:document.getElementById("carouselContainer"),carouselImage:document.getElementById("carouselImage"),prevBtn:document.getElementById("prevBtn"),nextBtn:document.getElementById("nextBtn"),dotsContainer:document.getElementById("dotsContainer")};function init(){const e=localStorage.getItem("kuttyCraftCart");e&&(cart=JSON.parse(e),updateCartUI()),loadMoreProducts(),setupEventListeners(),setupFooterFilters(),setupStickyHeader(),setupSmoothScroll(),updateLoadMoreButton()}function setupSmoothScroll(){document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){const t=this.getAttribute("href");if("#"===t)return void e.preventDefault();const n=document.querySelector(t);if(n){e.preventDefault();const t=80,a=n.getBoundingClientRect().top+window.pageYOffset-t;window.scrollTo({top:a,behavior:"smooth"})}})})}function setupStickyHeader(){window.addEventListener("scroll",()=>{window.scrollY>100?elements.header.classList.add("scrolled"):elements.header.classList.remove("scrolled")})}function setupEventListeners(){elements.filterButtons.forEach(e=>{e.addEventListener("click",handleFilterClick)}),elements.cartIcon.addEventListener("click",openCart),elements.cartClose.addEventListener("click",closeCart),elements.modalClose.addEventListener("click",closeModal),elements.modalOverlay.addEventListener("click",closeModal),elements.decreaseQty.addEventListener("click",decreaseQuantity),elements.increaseQty.addEventListener("click",increaseQuantity),elements.addToCartBtn.addEventListener("click",addToCart),elements.payNowBtn.addEventListener("click",openCheckoutModal),elements.checkoutClose.addEventListener("click",closeCheckoutModal),elements.checkoutOverlay.addEventListener("click",closeCheckoutModal),elements.checkoutForm.addEventListener("submit",handleCheckoutSubmit),elements.backHomeBtn.addEventListener("click",closeSuccessPage),elements.loadMoreBtn.addEventListener("click",handleLoadMore),elements.prevBtn.addEventListener("click",prevImage),elements.nextBtn.addEventListener("click",nextImage);const e=document.getElementById("downloadReceiptBtn");e&&e.addEventListener("click",downloadReceipt)}function updateCarousel(){if(!selectedProduct||!selectedProduct.images)return;const e=selectedProduct.images;elements.carouselImage.src=e[currentImageIndex];elements.dotsContainer.querySelectorAll(".carousel-dot").forEach((e,t)=>{t===currentImageIndex?e.classList.add("active"):e.classList.remove("active")}),e.length<=1?(elements.prevBtn.style.display="none",elements.nextBtn.style.display="none",elements.dotsContainer.style.display="none"):(elements.prevBtn.style.display="flex",elements.nextBtn.style.display="flex",elements.dotsContainer.style.display="flex")}function prevImage(){selectedProduct&&selectedProduct.images&&(currentImageIndex--,currentImageIndex<0&&(currentImageIndex=selectedProduct.images.length-1),updateCarousel())}function nextImage(){selectedProduct&&selectedProduct.images&&(currentImageIndex++,currentImageIndex>=selectedProduct.images.length&&(currentImageIndex=0),updateCarousel())}function createCarouselDots(){selectedProduct&&selectedProduct.images&&(elements.dotsContainer.innerHTML="",selectedProduct.images.forEach((e,t)=>{const n=document.createElement("div");n.className="carousel-dot",t===currentImageIndex&&n.classList.add("active"),n.addEventListener("click",()=>{currentImageIndex=t,updateCarousel()}),elements.dotsContainer.appendChild(n)}))}function handleFilterClick(e){const t=e.target.dataset.category;elements.filterButtons.forEach(e=>e.classList.remove("active")),e.target.classList.add("active"),currentFilter=t,currentPage=0,displayedProducts=[],elements.productsGrid.innerHTML="",loadMoreProducts(),updateLoadMoreButton()}function getFilteredProducts(){return"all"===currentFilter?allProducts:allProducts.filter(e=>e.category===currentFilter)}function loadMoreProducts(){const e=getFilteredProducts(),t=10*currentPage,n=t+10,a=e.slice(t,n);0!==a.length&&(a.forEach((e,t)=>{const n=createProductCard(e);n.style.animationDelay=.1*t+"s",elements.productsGrid.appendChild(n),displayedProducts.push(e)}),currentPage++,updateLoadMoreButton())}function createProductCard(e){const t=document.createElement("div");t.className="product-card",t.addEventListener("click",()=>openProductModal(e));const n=e.images&&e.images.length>0?e.images[0]:e.image;return t.innerHTML=`\n        <img src="${n}" alt="${e.title}" class="product-image">\n        <div class="product-info">\n            <div class="product-header">\n                <h3 class="product-name">${e.title}</h3>\n                ${e.isBestSeller?'<span class="best-seller-badge">Best Seller</span>':""}\n            </div>\n            <p class="product-price">‚Çπ${e.price}</p>\n        </div>\n    `,t}function handleLoadMore(){const e=getFilteredProducts();displayedProducts.length<e.length&&loadMoreProducts()}function updateLoadMoreButton(){const e=getFilteredProducts();displayedProducts.length<e.length?(elements.loadMoreContainer.classList.remove("hidden"),elements.allLoadedMessage.classList.remove("active")):(elements.loadMoreContainer.classList.add("hidden"),displayedProducts.length>0&&elements.allLoadedMessage.classList.add("active"))}function setupFooterFilters(){document.querySelectorAll(".filter-trigger").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.dataset.filter;elements.filterButtons.forEach(e=>e.classList.remove("active"));const n=Array.from(elements.filterButtons).find(e=>e.dataset.category===t);n&&n.classList.add("active"),currentFilter=t,currentPage=0,displayedProducts=[],elements.productsGrid.innerHTML="",loadMoreProducts();const a=document.querySelector(".products-section");if(a){const e=100,t=a.getBoundingClientRect().top+window.pageYOffset-e;window.scrollTo({top:t,behavior:"smooth"})}})})}function openProductModal(e){selectedProduct=e,currentQuantity=1,currentImageIndex=0,elements.modalTitle.textContent=e.title,elements.modalDescription.textContent=e.description,elements.modalPrice.textContent=`‚Çπ${e.price}`,elements.qtyValue.textContent=currentQuantity,createCarouselDots(),updateCarousel(),elements.productModal.classList.add("active"),document.body.style.overflow="hidden"}function closeModal(){elements.productModal.classList.remove("active"),document.body.style.overflow="auto",selectedProduct=null}function decreaseQuantity(){currentQuantity>1&&(currentQuantity--,elements.qtyValue.textContent=currentQuantity)}function increaseQuantity(){currentQuantity++,elements.qtyValue.textContent=currentQuantity}function addToCart(){if(!selectedProduct)return;const e=cart.find(e=>e.title===selectedProduct.title);e?e.quantity+=currentQuantity:cart.push({...selectedProduct,quantity:currentQuantity}),localStorage.setItem("kuttyCraftCart",JSON.stringify(cart)),updateCartUI(),closeModal(),openCart()}function updateCartUI(){const e=cart.reduce((e,t)=>e+t.quantity,0);elements.cartBadge.textContent=e,elements.cartBadge.style.display=e>0?"flex":"none",renderCartItems(),updateCartTotal()}function renderCartItems(){if(0===cart.length)return elements.cartEmpty.style.display="flex",elements.cartFooter.style.display="none",void(elements.cartItems.innerHTML="");elements.cartEmpty.style.display="none",elements.cartFooter.style.display="block",elements.cartItems.innerHTML=cart.map((e,t)=>`\n            <div class="cart-item">\n                <img src="${e.images&&e.images.length>0?e.images[0]:e.image}" alt="${e.title}" class="cart-item-image">\n                <div class="cart-item-details">\n                    <h4 class="cart-item-name">${e.title}</h4>\n                    <p class="cart-item-price">‚Çπ${e.price}</p>\n                    <p class="cart-item-quantity">Qty: ${e.quantity}</p>\n                </div>\n                <button class="cart-item-remove" onclick="removeFromCart(${t})">√ó</button>\n            </div>\n        `).join("")}function updateCartTotal(){const e=cart.reduce((e,t)=>e+t.price*t.quantity,0);elements.totalAmount.textContent=`‚Çπ${e}`}function removeFromCart(e){cart.splice(e,1),localStorage.setItem("kuttyCraftCart",JSON.stringify(cart)),updateCartUI()}function openCart(){elements.cartSidebar.classList.add("active")}function closeCart(){elements.cartSidebar.classList.remove("active")}function openCheckoutModal(){if(0===cart.length)return;const e=cart.reduce((e,t)=>e+t.price*t.quantity,0);elements.summaryItems.innerHTML=cart.map(e=>`\n        <div class="summary-item">\n            <span class="summary-item-name">${e.title}</span>\n            <span class="summary-item-qty">x${e.quantity}</span>\n            <span class="summary-item-price">‚Çπ${e.price*e.quantity}</span>\n        </div>\n    `).join(""),elements.summaryAmount.textContent=`‚Çπ${e}`,elements.checkoutForm.reset(),clearFormErrors(),elements.checkoutModal.classList.add("active"),document.body.style.overflow="hidden",closeCart()}function closeCheckoutModal(){elements.checkoutModal.classList.remove("active"),document.body.style.overflow="auto"}async function saveToGoogleSheets(e){if(!paymentDetails)return;const t=paymentDetails.items.map(e=>`${e.title} (Qty: ${e.quantity}, Price: ‚Çπ${e.price})`).join(" | "),n={secretToken:SECRET_TOKEN,orderId:paymentDetails.orderId,paymentId:paymentDetails.razorpayPaymentId||"N/A",status:e,customerName:paymentDetails.customerName,phone:paymentDetails.customerPhone,email:paymentDetails.customerEmail||"N/A",address:paymentDetails.customerAddress||"Not provided",items:t,itemCount:paymentDetails.items.reduce((e,t)=>e+t.quantity,0),totalAmount:paymentDetails.totalAmount,date:(new Date).toLocaleString("en-IN",{timeZone:"Asia/Kolkata",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}),errorCode:paymentDetails.errorCode||"N/A",errorDescription:paymentDetails.errorDescription||"N/A"};try{await fetch(GOOGLE_SHEET_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});return console.log("‚úÖ Payment data sent to Google Sheets"),console.log("üîí Security: Token validated"),saveToLocalStorage(e),!0}catch(t){return console.error("‚ùå Failed to save to Google Sheets:",t),saveToLocalStorage(e),!1}}function saveToLocalStorage(e){if(paymentDetails)try{let t=JSON.parse(localStorage.getItem("kuttyCraftPayments")||"[]");const n={...paymentDetails,status:e,timestamp:(new Date).toISOString(),savedDate:(new Date).toLocaleString("en-IN",{timeZone:"Asia/Kolkata"})};return t.push(n),t.length>100&&(t=t.slice(-100)),localStorage.setItem("kuttyCraftPayments",JSON.stringify(t)),console.log("üíæ Payment backup saved to localStorage"),!0}catch(e){return console.error("‚ùå Failed to save to localStorage:",e),!1}}function handleCheckoutSubmit(e){e.preventDefault(),clearFormErrors();const t=document.getElementById("customerName").value.trim(),n=document.getElementById("countryCode").value,a=document.getElementById("customerPhone").value.trim(),o=document.getElementById("customerEmail").value.trim(),r=document.getElementById("customerAddress").value.trim();let s=!0;if((!t||t.length<2)&&(showFormError("nameError","Please enter a valid name"),s=!1),a&&/^[0-9]{10}$/.test(a)||(showFormError("phoneError","Please enter a valid 10-digit phone number"),s=!1),o&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o)&&(showFormError("emailError","Please enter a valid email address"),s=!1),(!r||r.length<10)&&(showFormError("addressError","Please enter your complete delivery address"),s=!1),!s)return;const l="KC"+Date.now(),c=cart.reduce((e,t)=>e+t.price*t.quantity,0),d=cart.map(e=>`${e.title} x ${e.quantity}`).join(", "),i=n+a,m=new Razorpay({key:"rzp_test_S6snJWXeIbWAu2",amount:100*c,currency:"INR",name:"Kutty Craft",description:"Order ID: "+l,prefill:{name:t,email:o,contact:a},notes:{order_id:l,customer_name:t,phone:i,address:r||"Not provided",products:d},theme:{color:"#ff9a76"},handler:function(e){console.log("‚úÖ Payment Successful!"),console.log("Payment ID:",e.razorpay_payment_id),paymentDetails={razorpayPaymentId:e.razorpay_payment_id,orderId:l,customerName:t,customerPhone:i,customerEmail:o,customerAddress:r,items:[...cart],totalAmount:c,orderDate:(new Date).toISOString()},saveToGoogleSheets("SUCCESS"),closeCheckoutModal(),showSuccessPage(),cart=[],localStorage.removeItem("kuttyCraftCart"),updateCartUI()}});m.on("payment.failed",function(e){console.error("‚ùå Payment Failed!"),console.error("Error:",e.error),paymentDetails={orderId:l,customerName:t,customerPhone:i,customerEmail:o,customerAddress:r,items:[...cart],totalAmount:c,orderDate:(new Date).toISOString(),errorCode:e.error.code,errorDescription:e.error.description,errorSource:e.error.source,errorStep:e.error.step,errorReason:e.error.reason},saveToGoogleSheets("FAILED"),alert("Payment failed. Please try again.\n\nError: "+e.error.description)}),m.open()}function showFormError(e,t){const n=document.getElementById(e);n&&(n.textContent=t,n.classList.add("active"))}function clearFormErrors(){document.querySelectorAll(".form-error").forEach(e=>{e.textContent="",e.classList.remove("active")})}function showSuccessPage(){if(!paymentDetails)return;document.getElementById("successOrderId").textContent=paymentDetails.orderId,document.getElementById("successPaymentId").textContent=paymentDetails.razorpayPaymentId,document.getElementById("successCustomerName").textContent=paymentDetails.customerName,document.getElementById("successTotalAmount").textContent=`‚Çπ${paymentDetails.totalAmount}`;document.getElementById("successItemsList").innerHTML=paymentDetails.items.map(e=>`\n        <div class="success-item">\n            <span class="success-item-name">${e.title}</span>\n            <span class="success-item-qty">x${e.quantity}</span>\n            <span class="success-item-price">‚Çπ${e.price*e.quantity}</span>\n        </div>\n    `).join(""),elements.successPage.classList.add("active")}function closeSuccessPage(){elements.successPage.classList.remove("active"),paymentDetails=null}function downloadReceipt(){if(!paymentDetails)return;const e=window.open("","_blank","width=800,height=1000"),t=`\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset="UTF-8">\n    <title>Kutty Craft - Receipt ${paymentDetails.orderId}</title>\n    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;600;700&family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">\n    <style>\n        * { margin: 0; padding: 0; box-sizing: border-box; }\n        body {\n            font-family: 'Quicksand', sans-serif;\n            padding: 40px;\n            background: #fff;\n            color: #4a4a4a;\n        }\n        .receipt-container {\n            max-width: 650px;\n            margin: 0 auto;\n            background: white;\n            padding: 40px;\n            border: 2px solid #f0e6d2;\n            border-radius: 16px;\n        }\n        .header {\n            text-align: center;\n            margin-bottom: 30px;\n            padding-bottom: 20px;\n            border-bottom: 2px solid #ff9a76;\n        }\n        .brand-name {\n            font-family: 'Comfortaa', cursive;\n            font-size: 2rem;\n            color: #ff7f50;\n            margin-bottom: 5px;\n        }\n        .receipt-title {\n            color: #4CAF50;\n            font-size: 1.5rem;\n            margin-top: 10px;\n        }\n        .detail-section {\n            margin: 20px 0;\n            padding: 20px;\n            background: #fffbf5;\n            border-radius: 8px;\n        }\n        .detail-row {\n            display: flex;\n            justify-content: space-between;\n            padding: 8px 0;\n            border-bottom: 1px solid #f0e6d2;\n        }\n        .detail-row:last-child { border-bottom: none; }\n        .detail-label {\n            font-weight: 600;\n            color: #4a4a4a;\n        }\n        .detail-value {\n            color: #7a7a7a;\n        }\n        .items-section {\n            margin: 20px 0;\n        }\n        .items-title {\n            font-family: 'Comfortaa', cursive;\n            font-size: 1.2rem;\n            margin-bottom: 15px;\n            color: #4a4a4a;\n        }\n        .item-row {\n            display: flex;\n            justify-content: space-between;\n            padding: 12px;\n            background: #fffbf5;\n            margin-bottom: 8px;\n            border-radius: 8px;\n        }\n        .item-name { flex: 1; font-weight: 500; }\n        .item-qty { margin: 0 15px; color: #7a7a7a; }\n        .item-price { font-weight: 600; color: #ff7f50; }\n        .total-section {\n            margin: 30px 0;\n            padding: 20px;\n            background: linear-gradient(135deg, #fff5f0 0%, #ffe9dd 100%);\n            border-radius: 8px;\n            text-align: right;\n        }\n        .total-label {\n            font-size: 1.2rem;\n            font-weight: 600;\n            color: #4a4a4a;\n        }\n        .total-amount {\n            font-family: 'Comfortaa', cursive;\n            font-size: 2rem;\n            color: #ff7f50;\n            font-weight: 700;\n            margin-top: 5px;\n        }\n        .footer {\n            text-align: center;\n            margin-top: 30px;\n            padding-top: 20px;\n            border-top: 2px solid #f0e6d2;\n            color: #7a7a7a;\n        }\n        @media print {\n            body { padding: 20px; }\n            .no-print { display: none; }\n        }\n        .print-btn {\n            background: #4CAF50;\n            color: white;\n            border: none;\n            padding: 12px 30px;\n            border-radius: 8px;\n            font-size: 1rem;\n            cursor: pointer;\n            margin: 20px auto;\n            display: block;\n        }\n        .print-btn:hover { background: #45a049; }\n    </style>\n</head>\n<body>\n    <div class="receipt-container">\n        <div class="header">\n            <h1 class="brand-name">Kutty Craft</h1>\n            <p style="color: #7a7a7a;">Handmade with Love ‚ù§Ô∏è</p>\n            <h2 class="receipt-title">‚úì Payment Successful</h2>\n        </div>\n\n        <div class="detail-section">\n            <div class="detail-row">\n                <span class="detail-label">Order ID:</span>\n                <span class="detail-value">${paymentDetails.orderId}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Payment ID:</span>\n                <span class="detail-value">${paymentDetails.razorpayPaymentId}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Customer Name:</span>\n                <span class="detail-value">${paymentDetails.customerName}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Phone:</span>\n                <span class="detail-value">${paymentDetails.customerPhone}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Email:</span>\n                <span class="detail-value">${paymentDetails.customerEmail||"N/A"}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Delivery Address:</span>\n                <span class="detail-value">${paymentDetails.customerAddress}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Date:</span>\n                <span class="detail-value">${new Date(paymentDetails.orderDate).toLocaleString("en-IN",{timeZone:"Asia/Kolkata"})}</span>\n            </div>\n        </div>\n\n        <div class="items-section">\n            <h3 class="items-title">Items Purchased</h3>\n            ${paymentDetails.items.map(e=>`\n                <div class="item-row">\n                    <span class="item-name">${e.title}</span>\n                    <span class="item-qty">x${e.quantity}</span>\n                    <span class="item-price">‚Çπ${e.price*e.quantity}</span>\n                </div>\n            `).join("")}\n        </div>\n\n        <div class="total-section">\n            <div class="total-label">Total Amount Paid</div>\n            <div class="total-amount">‚Çπ${paymentDetails.totalAmount}</div>\n        </div>\n\n        <div class="footer">\n            <p><strong>Thank you for shopping with Kutty Craft!</strong></p>\n            <p style="margin-top: 10px;">For queries, contact: +91 8270282928</p>\n            <p style="margin-top: 5px;">Email: hello@kuttycraft.com</p>\n        </div>\n\n        <button class="print-btn no-print" onclick="window.print()">\n            Print / Save as PDF\n        </button>\n    </div>\n</body>\n</html>\n    `;e.document.write(t),e.document.close()}function downloadPaymentHistory(){try{const e=JSON.parse(localStorage.getItem("kuttyCraftPayments")||"[]");if(0===e.length)return void alert("No payment records found in browser storage.");const t=[["Order ID","Payment ID","Status","Customer Name","Phone","Email","Amount","Date","Items"]];e.forEach(e=>{const n=e.items.map(e=>`${e.title}(${e.quantity})`).join("; ");t.push([e.orderId,e.razorpayPaymentId||"N/A",e.status,e.customerName,e.customerPhone,e.customerEmail||"N/A",e.totalAmount,e.savedDate||new Date(e.timestamp).toLocaleString(),n])});const n=t.map(e=>e.map(e=>`"${e}"`).join(",")).join("\n"),a=new Blob([n],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(a),r=document.createElement("a");r.href=o,r.download=`kuttycraft-payment-history-${(new Date).toISOString().split("T")[0]}.csv`,r.click(),URL.revokeObjectURL(o),console.log(`‚úÖ Downloaded ${e.length} payment records`)}catch(e){console.error("Failed to download payment history:",e),alert("Failed to download payment history")}}document.addEventListener("DOMContentLoaded",init),document.addEventListener("contextmenu",e=>e.preventDefault()),document.addEventListener("keydown",e=>{"F12"===e.key&&e.preventDefault()});